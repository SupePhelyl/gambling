<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Garlic Trader</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #111;
      color: #f5f5f5;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    .tabs, .subtabs {
      display: flex;
      overflow-x: auto;
      margin-bottom: 10px;
    }
    .tab, .subtab {
      background: #333;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }
    .tab.active, .subtab.active {
      background: #ffd700;
      color: #000;
    }
    .content {
      background: #222;
      padding: 20px;
      border-radius: 0 0 12px 12px;
    }
    .hidden {
      display: none;
    }
    button {
      padding: 10px 20px;
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>Garlic TraderğŸ§„</h1>

  <!-- Autoryzacja -->
  <div id="auth-section">
    <button id="loginBtn">Zaloguj przez Google</button>
    <button id="logoutBtn" style="display:none;">Wyloguj</button>
    <p id="user-info">Nie jesteÅ› zalogowany.</p>
  </div>

  <!-- GÅ‚Ã³wne zakÅ‚adki -->
  <div class="tabs" id="mainTabs">
    <div class="tab" data-tab="market" style="display: none;">Market</div>
    <div class="tab" data-tab="farm" style="display: none;">Farma</div>
    <div class="tab active" data-tab="toplist">Top listy</div>
  </div>

  <div class="content">
    <!-- Market -->
    <div id="market" class="tab-content hidden">
      <div class="subtabs">
        <div class="subtab active" data-subtab="buy">KupiÄ™</div>
        <div class="subtab" data-subtab="sell">Sprzedam</div>
      </div>
      <div id="buy" class="subtab-content">
        <p>ğŸ›’ Kup czosnek na rynku!</p>
      </div>
      <div id="sell" class="subtab-content hidden">
        <p>ğŸ’° Sprzedaj swÃ³j czosnek innym graczom!</p>
      </div>
    </div>

    <!-- Farma -->
    <div id="farm" class="tab-content hidden">
      <p>ğŸŒ± Tu moÅ¼esz zarzÄ…dzaÄ‡ swojÄ… farmÄ… czosnku.</p>
    </div>

    <!-- Top listy -->
    <div id="toplist" class="tab-content">
      <p>âš”ï¸ Najlepsi gracze Garlic Trader:</p>
      <div id="leaderboard">Åadowanie Top listy...</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // Firebase config (zakodowany â†’ dekodowany base64)
    const encodedConfig = {
      apiKey: "QUl6YVN5Q280RTg4ZUpydW1TcGgxZ3lpelB4TUcybm4yWXlNVng4",
      authDomain: "Z2llbGRhLTIwMTcyLmZpcmViYXNlYXBwLmNvbQ==",
      projectId: "Z2llbGRhLTIwMTcy",
      storageBucket: "Z2llbGRhLTIwMTcyLmFwcHNwb3QuY29t",
      messagingSenderId: "OTg1NDU1NzcwODA1",
      appId: "MTo5ODU0NTU3NzA4MDU6d2ViOmE4MGFhZjUzNmE2YTVkMDY0YzUyZmM=",
      measurementId: "Ry1ZMFlFOUxZUjQ5"
    };
    const firebaseConfig = {};
    for (const key in encodedConfig) {
      firebaseConfig[key] = atob(encodedConfig[key]);
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Logowanie
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("user-info");

    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert("BÅ‚Ä…d logowania: " + e.message);
      }
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth);
    });

    // ObsÅ‚uga zakÅ‚adek gÅ‚Ã³wnych
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.add("hidden"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.remove("hidden");
      });
    });

    // ObsÅ‚uga subzakÅ‚adek (market)
    const subtabs = document.querySelectorAll(".subtab");
    const subcontents = document.querySelectorAll(".subtab-content");

    subtabs.forEach(subtab => {
      subtab.addEventListener("click", () => {
        subtabs.forEach(st => st.classList.remove("active"));
        subcontents.forEach(sc => sc.classList.add("hidden"));
        subtab.classList.add("active");
        document.getElementById(subtab.dataset.subtab).classList.remove("hidden");
      });
    });

    // ObsÅ‚uga stanu logowania
    onAuthStateChanged(auth, (user) => {
      const marketTab = document.querySelector('[data-tab="market"]');
      const farmTab = document.querySelector('[data-tab="farm"]');
      if (user) {
        userInfo.textContent = `Zalogowany jako: ${user.displayName}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        marketTab.style.display = "";
        farmTab.style.display = "";
      } else {
        userInfo.textContent = "Nie jesteÅ› zalogowany.";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        marketTab.style.display = "none";
        farmTab.style.display = "none";

        // JeÅ›li uÅ¼ytkownik byÅ‚ na niedozwolonej zakÅ‚adce, przeÅ‚Ä…cz go na Top listy
        if (!document.querySelector('[data-tab="toplist"]').classList.contains('active')) {
          tabs.forEach(t => t.classList.remove('active'));
          contents.forEach(c => c.classList.add('hidden'));
          const toplistTab = document.querySelector('[data-tab="toplist"]');
          toplistTab.classList.add('active');
          document.getElementById("toplist").classList.remove("hidden");
        }
      }
    });

    // Åadowanie Top listy
    async function loadTopList() {
      const el = document.getElementById('leaderboard');
      el.textContent = 'Åadowanie...';
      try {
        const q = query(collection(db, 'garlic-leaderboard'), orderBy('score', 'desc'), limit(10));
        const docs = await getDocs(q);
        if (docs.empty) {
          el.textContent = 'Brak danych w Top listach.';
          return;
        }
        const list = Array.from(docs).map(doc => {
          const d = doc.data();
          return `${d.name}: ${d.score.toFixed(2)}`;
        });
        el.innerHTML = '<ol>' + list.map(i => `<li>${i}</li>`).join('') + '</ol>';
      } catch(e) {
        el.textContent = 'BÅ‚Ä…d Å‚adowania Top list.';
        console.error(e);
      }
    }

    loadTopList();
  </script>
</body>
</html>
