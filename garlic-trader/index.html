<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Garlic Trader</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #111;
      color: #f5f5f5;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    .tabs, .subtabs {
      display: flex;
      overflow-x: auto;
      margin-bottom: 10px;
    }
    .tab, .subtab {
      background: #333;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }
    .tab.active, .subtab.active {
      background: #ffd700;
      color: #000;
    }
    .content {
      background: #222;
      padding: 20px;
      border-radius: 0 0 12px 12px;
    }
    .hidden {
      display: none;
    }
    #status {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>Garlic Trader 🧄</h1>
  <div id="status">🧄 0 | 💰 100</div>

  <!-- Główne zakładki -->
  <div class="tabs" id="mainTabs">
    <div class="tab active" data-tab="market">Market</div>
    <div class="tab" data-tab="farm">Farma</div>
    <div class="tab" data-tab="toplist">Top listy</div>
  </div>

  <div class="content">
    <!-- Zakładka Market -->
    <div id="market" class="tab-content">
      <div class="subtabs">
        <div class="subtab active" data-subtab="buy">Kupię</div>
        <div class="subtab" data-subtab="sell">Sprzedam</div>
      </div>
      <div id="buy" class="subtab-content">
        <p>🛒 Kup czosnek na rynku!</p>
      </div>
      <div id="sell" class="subtab-content hidden">
        <p>💰 Sprzedaj swój czosnek innym graczom!</p>
      </div>
    </div>

    <!-- Farma -->
    <div id="farm" class="tab-content hidden">
      <p>Farma czosnku – tu możesz zasadzić, zebrać i zarządzać zasobami.</p>
    </div>

    <!-- Top Listy -->
    <div id="toplist" class="tab-content hidden">
      <p>⚔️ Top 10 graczy wg czosnku:</p>
      <div id="topGarlic">Ładowanie...</div>
      <p>💰 Top 10 graczy wg pieniędzy:</p>
      <div id="topMoney">Ładowanie...</div>
    </div>
  </div>

  <!-- Firebase & Auth & Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const encodedConfig = {
      apiKey: "QUl6YVN5Q280RTg4ZUpydW1TcGgxZ3lpelB4TUcybm4yWXlNVng4",
      authDomain: "Z2llbGRhLTIwMTcyLmZpcmViYXNlYXBwLmNvbQ==",
      projectId: "Z2llbGRhLTIwMTcy",
      storageBucket: "Z2llbGRhLTIwMTcyLmFwcHNwb3QuY29t",
      messagingSenderId: "OTg1NDU1NzcwODA1",
      appId: "MTo5ODU0NTU3NzA4MDU6d2ViOmE4MGFhZjUzNmE2YTVkMDY0YzUyZmM=",
      measurementId: "Ry1ZMFlFOUxZUjQ5"
    };
    const firebaseConfig = {};
    for (const key in encodedConfig) {
      firebaseConfig[key] = atob(encodedConfig[key]);
    }
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let garlic = 0, money = 100;

    const status = document.getElementById("status");

    // Obsługa zakładek
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.remove('hidden');
      });
    });
    document.querySelectorAll('.subtab').forEach(subtab => {
      subtab.addEventListener('click', () => {
        document.querySelectorAll('.subtab').forEach(st => st.classList.remove('active'));
        document.querySelectorAll('.subtab-content').forEach(sc => sc.classList.add('hidden'));
        subtab.classList.add('active');
        document.getElementById(subtab.dataset.subtab).classList.remove('hidden');
      });
    });

    function updateStatusDisplay() {
      status.textContent = `🧄 ${garlic} | 💰 ${money}`;
    }

    async function loadUserData(user) {
      const docRef = doc(db, "garlic-leaderboard", user.uid);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        garlic = data.garlic ?? 0;
        money = data.money ?? 100;
      } else {
        garlic = 0;
        money = 100;
        await setDoc(docRef, {
          name: user.displayName,
          garlic,
          money
        });
      }
      updateStatusDisplay();
    }

    async function saveUserData() {
      if (!currentUser) return;
      await setDoc(doc(db, "garlic-leaderboard", currentUser.uid), {
        name: currentUser.displayName,
        garlic,
        money
      });
    }

    async function loadTopLists() {
      const topGarlic = document.getElementById("topGarlic");
      const topMoney = document.getElementById("topMoney");

      const qGarlic = query(collection(db, "garlic-leaderboard"), orderBy("garlic", "desc"), limit(10));
      const qMoney = query(collection(db, "garlic-leaderboard"), orderBy("money", "desc"), limit(10));

      const [snapGarlic, snapMoney] = await Promise.all([getDocs(qGarlic), getDocs(qMoney)]);

      topGarlic.innerHTML = "<ol>" + snapGarlic.docs.map(doc => {
        const d = doc.data();
        return `<li>${d.name}: 🧄 ${d.garlic ?? 0}</li>`;
      }).join('') + "</ol>";

      topMoney.innerHTML = "<ol>" + snapMoney.docs.map(doc => {
        const d = doc.data();
        return `<li>${d.name}: 💰 ${d.money ?? 0}</li>`;
      }).join('') + "</ol>";
    }

    // Logowanie Google (automatyczne)
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        await loadUserData(user);
      } else {
        signInWithPopup(auth, provider).catch(console.error);
      }
    });

    loadTopLists();
  </script>
</body>
</html>
