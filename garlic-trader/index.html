<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Garlic Trader</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #111;
      color: #f5f5f5;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    .tabs, .subtabs {
      display: flex;
      overflow-x: auto;
      margin-bottom: 10px;
    }
    .tab, .subtab {
      background: #333;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }
    .tab.active, .subtab.active {
      background: #ffd700;
      color: #000;
    }
    .content {
      background: #222;
      padding: 20px;
      border-radius: 0 0 12px 12px;
    }
    .hidden {
      display: none !important;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .status {
      font-size: 16px;
    }
    .button {
      background: #ffd700;
      color: #000;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 5px;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: #222;
      padding: 20px;
      border-radius: 12px;
      width: 300px;
      box-sizing: border-box;
      color: #f5f5f5;
      position: relative;
    }
    .modal h2 {
      margin-top: 0;
    }
    .modal label {
      display: block;
      margin: 10px 0 5px;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: none;
      box-sizing: border-box;
    }
    .modal button {
      margin-top: 15px;
      width: 100%;
      padding: 10px;
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-weight: bold;
      color: #ffd700;
      font-size: 20px;
    }
    /* Offers list */
    .offer {
      background: #333;
      padding: 15px 20px;
      margin-bottom: 12px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      color: #eee;
    }
    
    .offer-details {
      flex-grow: 1;
      padding-right: 20px;
    }
    
    .offer-name {
      font-weight: 700;
      font-size: 28px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    
    .offer-user, .offer-price, .offer-amount {
      font-size: 14px;
      margin-bottom: 4px;
      color: #ccc;
    }
    
    .offer button {
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 8px;
      margin-left: 10px;
      cursor: pointer;
      padding: 10px 18px;
      font-weight: 600;
      transition: background-color 0.3s ease;
      align-self: flex-start;
      height: fit-content;
    }
    
    .offer button:hover {
      background-color: #e6c200;
    }


  </style>
</head>
<body>
  <div class="top-bar">
    <div class="status">
      üßÑ Czosnek: <span id="garlic-count">-</span> | üíµ $: <span id="money-count">-</span>
    </div>
    <div>
      <button class="button" id="login-btn">Zaloguj siƒô</button>
      <button class="button hidden" id="logout-btn">Wyloguj siƒô</button>
    </div>
  </div>
  <h1>Garlic TraderüßÑ</h1>

  <div class="tabs" id="mainTabs">
    <div class="tab" data-tab="market">Market</div>
    <div class="tab" data-tab="farm">Farma</div>
    <div class="tab active" data-tab="toplist">Top listy</div>
  </div>

  <div class="content">
    <div id="market" class="tab-content hidden">
      <div class="subtabs">
        <div class="subtab active" data-subtab="buy">Kupiƒô</div>
        <div class="subtab" data-subtab="sell">Sprzedam</div>
      </div>

      <!-- Przycisk dodawania oferty -->
      <button class="button" id="add-offer-btn">Dodaj ofertƒô</button>

      <div id="buy" class="subtab-content">
        <p>üõí Kup czosnek na rynku!</p>
        <div id="offers-buy">≈Åadowanie ofert kupna...</div>
      </div>

      <div id="sell" class="subtab-content hidden">
        <p>üí∞ Sprzedaj sw√≥j czosnek innym graczom!</p>
        <div id="offers-sell">≈Åadowanie ofert sprzeda≈ºy...</div>
      </div>
    </div>

    <div id="farm" class="tab-content hidden">
      <p>Farma czosnku ‚Äì tu mo≈ºesz zasadziƒá, zebraƒá i zarzƒÖdzaƒá zasobami.</p>
    </div>

    <div id="toplist" class="tab-content">
      <p>ü•á Top gracze wg ilo≈õci czosnku:</p>
      <div id="top-garlic">≈Åadowanie...</div>
      <p>üíµ Top gracze wg ilo≈õci pieniƒôdzy:</p>
      <div id="top-money">≈Åadowanie...</div>
    </div>
  </div>

  <!-- Modal dodawania oferty -->
  <div id="offer-modal" class="modal-overlay hidden">
    <div class="modal">
      <span class="modal-close" id="offer-modal-close">&times;</span>
      <h2>Dodaj ofertƒô</h2>
      <form id="offer-form">
        <label for="offer-type">Typ oferty:</label>
        <select id="offer-type" required>
          <option value="buy">Kupiƒô</option>
          <option value="sell">Sprzedam</option>
        </select>
        <label for="offer-name">Nazwa oferty:</label>
        <input type="text" id="offer-name" required placeholder="Nazwa towaru" />
        <label for="offer-amount">Ilo≈õƒá:</label>
        <input type="number" id="offer-amount" min="1" required placeholder="Ilo≈õƒá" />
        <label for="offer-price">Cena za sztukƒô ($):</label>
        <input type="number" id="offer-price" min="0.01" step="0.01" required placeholder="Cena" />
        <button type="submit">Dodaj ofertƒô</button>
      </form>
    </div>
  </div>
  
  <!-- Modal handlu -->
  <div id="trade-modal" class="modal-overlay hidden">
    <div class="modal">
      <span class="modal-close" id="trade-modal-close">&times;</span>
      <h2 id="trade-title">Handel</h2>
      <p id="trade-info"></p>
      <form id="trade-form">
        <label for="trade-quantity">Ilo≈õƒá:</label>
        <input type="number" id="trade-quantity" min="1" required />
        <button type="submit">Wykonaj handel</button>
      </form>
    </div>
  </div>



  <script type="module">
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, orderBy, limit, addDoc, where } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const encodedConfig = {
      apiKey: "QUl6YVN5Q280RTg4ZUpydW1TcGgxZ3lpelB4TUcybm4yWXlNVng4",
      authDomain: "Z2llbGRhLTIwMTcyLmZpcmViYXNlYXBwLmNvbQ==",
      projectId: "Z2llbGRhLTIwMTcy",
      storageBucket: "Z2llbGRhLTIwMTcyLmFwcHNwb3QuY29t",
      messagingSenderId: "OTg1NDU1NzcwODA1",
      appId: "MTo5ODU0NTU3NzA4MDU6d2ViOmE4MGFhZjUzNmE2YTVkMDY0YzUyZmM="
    };
    const firebaseConfig = {};
    for (const key in encodedConfig) {
      firebaseConfig[key] = atob(encodedConfig[key]);
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const garlicCount = document.getElementById("garlic-count");
    const moneyCount = document.getElementById("money-count");

    const addOfferBtn = document.getElementById("add-offer-btn");
    const offerModal = document.getElementById("offer-modal");
    const offerModalClose = document.getElementById("offer-modal-close");
    const offerForm = document.getElementById("offer-form");

    const tradeModal = document.getElementById("trade-modal");
    const tradeModalClose = document.getElementById("trade-modal-close");

    const offersBuyDiv = document.getElementById("offers-buy");
    const offersSellDiv = document.getElementById("offers-sell");

    let currentUser = null;

    loginBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, async user => {
      const marketTab = document.querySelector('[data-tab="market"]');
      const farmTab = document.querySelector('[data-tab="farm"]');
      if (user) {
        currentUser = user;
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        marketTab.classList.remove("hidden");
        farmTab.classList.remove("hidden");
        addOfferBtn.style.display = "inline-block";
        await loadOrCreatePlayer(user);
        await loadOffers();
      } else {
        currentUser = null;
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        garlicCount.textContent = "-";
        moneyCount.textContent = "-";
        marketTab.classList.add("hidden");
        farmTab.classList.add("hidden");
        addOfferBtn.style.display = "none";
        offersBuyDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        offersSellDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        document.querySelector('[data-tab="toplist"]').click();
      }
    });

    async function loadOrCreatePlayer(user) {
      const ref = doc(db, "garlic-leaderboard", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { name: user.displayName, garlic: 0, money: 100 });
        garlicCount.textContent = 0;
        moneyCount.textContent = 100;
      } else {
        const data = snap.data();
        garlicCount.textContent = data.garlic;
        moneyCount.textContent = data.money;
      }
    }

    async function loadTopLists() {
      const garlicDiv = document.getElementById("top-garlic");
      const moneyDiv = document.getElementById("top-money");

      try {
        const ref = collection(db, "garlic-leaderboard");

        const garlicQ = query(ref, orderBy("garlic", "desc"), limit(10));
        const moneyQ = query(ref, orderBy("money", "desc"), limit(10));

        const garlicSnap = await getDocs(garlicQ);
        const moneySnap = await getDocs(moneyQ);

        garlicDiv.innerHTML = "<ol>" + garlicSnap.docs.map(doc => `<li>${doc.data().name}: ${doc.data().garlic}</li>`).join("") + "</ol>";
        moneyDiv.innerHTML = "<ol>" + moneySnap.docs.map(doc => `<li>${doc.data().name}: $${doc.data().money}</li>`).join("") + "</ol>";
      } catch (e) {
        garlicDiv.textContent = moneyDiv.textContent = "B≈ÇƒÖd ≈Çadowania top list.";
        console.error(e);
      }
    }

    // ≈Åaduj top listy od razu
    loadTopLists();

    // Tab switching logic
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if ((tab.dataset.tab === 'market' || tab.dataset.tab === 'farm') && !currentUser) return;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.remove('hidden');
      });
    });

    document.querySelectorAll('.subtab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.subtab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.subtab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.subtab).classList.remove('hidden');
      });
    });

    // Obs≈Çuga modala dodawania oferty
    addOfferBtn.addEventListener('click', () => {
      if (!currentUser) return alert("Zaloguj siƒô, aby dodaƒá ofertƒô.");
      offerForm.reset();
      // Ustaw typ oferty w modalu wg aktualnej subtaba (buy/sell)
      const activeSubtab = document.querySelector('.subtab.active').dataset.subtab;
      document.getElementById("offer-type").value = activeSubtab;
      offerModal.classList.remove('hidden');
    });

    offerModalClose.addEventListener('click', () => {
      offerModal.classList.add('hidden');
    });

    offerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Zaloguj siƒô, aby dodaƒá ofertƒô.");
    
      const type = document.getElementById("offer-type").value;
      const name = document.getElementById("offer-name").value.trim();
      const amount = parseInt(document.getElementById("offer-amount").value, 10);
      const price = parseFloat(document.getElementById("offer-price").value);
    
      if (!name || amount <= 0 || price <= 0) {
        return alert("Proszƒô podaƒá poprawne dane.");
      }
    
      // Pobierz zasoby u≈ºytkownika
      const userRef = doc(db, "garlic-leaderboard", currentUser.uid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return alert("Brak danych u≈ºytkownika.");
    
      const userData = userSnap.data();
    
      // Sprawd≈∫ i zmodyfikuj zasoby w zale≈ºno≈õci od typu oferty
      if (type === "sell") {
        // Sprzeda≈º - zmniejsz czosnek
        if (userData.garlic < amount) {
          return alert("Nie masz tyle czosnku.");
        }
        await setDoc(userRef, { garlic: userData.garlic - amount }, { merge: true });
      } else {
        // Kupno - zmniejsz pieniƒÖdze
        const cost = amount * price;
        if (userData.money < cost) {
          return alert("Nie masz tyle pieniƒôdzy.");
        }
        await setDoc(userRef, { money: userData.money - cost }, { merge: true });
      }
    
      try {
        await addDoc(collection(db, "offers"), {
          userId: currentUser.uid,
          userName: currentUser.displayName,
          type,
          name,
          amount,
          price,
          createdAt: new Date()
        });
    
        // Od≈õwie≈º zasoby i oferty
        garlicCount.textContent = type === "sell" ? userData.garlic - amount : userData.garlic;
        moneyCount.textContent = type === "buy" ? userData.money - (amount * price) : userData.money;
    
        offerModal.classList.add('hidden');
        loadOffers();
      } catch (error) {
        alert("B≈ÇƒÖd podczas dodawania oferty.");
        console.error(error);
      }
    });


    // ≈Åadowanie ofert z Firestore i wy≈õwietlanie ich
    async function loadOffers() {
      if (!currentUser) {
        offersBuyDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        offersSellDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        return;
      }

      offersBuyDiv.textContent = "≈Åadowanie...";
      offersSellDiv.textContent = "≈Åadowanie...";

      try {
        const offersRef = collection(db, "offers");

        // Kupno
        const buyQuery = query(offersRef, where("type", "==", "buy"), orderBy("createdAt", "desc"), limit(20));
        // Sprzeda≈º
        const sellQuery = query(offersRef, where("type", "==", "sell"), orderBy("createdAt", "desc"), limit(20));

        const [buySnap, sellSnap] = await Promise.all([getDocs(buyQuery), getDocs(sellQuery)]);

        // Wy≈õwietl kupiƒô
        if (buySnap.empty) {
          offersBuyDiv.innerHTML = "<p>Brak ofert kupna.</p>";
        } else {
          offersBuyDiv.innerHTML = "";
          buySnap.forEach(doc => {
            const data = doc.data();
            const offerEl = createOfferElement(doc.id, data);
            offersBuyDiv.appendChild(offerEl);
          });
        }

        // Wy≈õwietl sprzedam
        if (sellSnap.empty) {
          offersSellDiv.innerHTML = "<p>Brak ofert sprzeda≈ºy.</p>";
        } else {
          offersSellDiv.innerHTML = "";
          sellSnap.forEach(doc => {
            const data = doc.data();
            const offerEl = createOfferElement(doc.id, data);
            offersSellDiv.appendChild(offerEl);
          });
        }
      } catch (e) {
        offersBuyDiv.textContent = "B≈ÇƒÖd ≈Çadowania ofert.";
        offersSellDiv.textContent = "B≈ÇƒÖd ≈Çadowania ofert.";
        console.error(e);
      }
    }

    // Tworzy element oferty z przyciskiem "Handluj"
    function createOfferElement(id, data) {
      const div = document.createElement("div");
      div.className = "offer";
    
      const details = document.createElement("div");
      details.className = "offer-details";
    
      const nameEl = document.createElement("div");
      nameEl.className = "offer-name";
      nameEl.textContent = data.name.toUpperCase();
    
      const action = data.type === "buy" ? "kupiƒá" : "sprzedaƒá";
      const amountLabel = data.type === "buy" ? "Zapotrzebowanie" : "Zapas";
    
      const userEl = document.createElement("div");
      userEl.className = "offer-user";
      userEl.textContent = `${data.userName} chce ${action} czosnek.`;
    
      const priceEl = document.createElement("div");
      priceEl.className = "offer-price";
      priceEl.textContent = `Cena za sztukƒô: $${data.price.toFixed(2)}`;
    
      const amountEl = document.createElement("div");
      amountEl.className = "offer-amount";
      amountEl.textContent = `${amountLabel}: ${data.amount} szt.`;
    
      details.appendChild(nameEl);
      details.appendChild(userEl);
      details.appendChild(priceEl);
      details.appendChild(amountEl);
    
      div.appendChild(details);
    
      const actions = document.createElement("div");
    
      // Przycisk handlu
      const tradeBtn = document.createElement("button");
      tradeBtn.textContent = "Handluj";
      tradeBtn.onclick = () => {
        tradeModal.classList.remove("hidden");
      };
      actions.appendChild(tradeBtn);
    
      // Je≈õli oferta nale≈ºy do zalogowanego u≈ºytkownika, dodaj przyciski Edytuj i Usu≈Ñ
      if (currentUser && currentUser.uid === data.userId) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edytuj";
        editBtn.style.marginTop = "6px";
        editBtn.onclick = async () => {
          document.getElementById("offer-type").value = data.type;
          document.getElementById("offer-name").value = data.name;
          document.getElementById("offer-amount").value = data.amount;
          document.getElementById("offer-price").value = data.price;
          offerModal.classList.remove("hidden");
    
          // Po klikniƒôciu zapisu, zaktualizuj zamiast dodawaƒá nowƒÖ
          const formClone = offerForm.cloneNode(true);
          offerForm.replaceWith(formClone);
    
          formClone.onsubmit = async (e) => {
            e.preventDefault();
          
            const newType = document.getElementById("offer-type").value;
            const newName = document.getElementById("offer-name").value.trim();
            const newAmount = parseInt(document.getElementById("offer-amount").value, 10);
            const newPrice = parseFloat(document.getElementById("offer-price").value);
          
            if (!newName || newAmount <= 0 || newPrice <= 0) {
              return alert("Proszƒô podaƒá poprawne dane.");
            }
          
            // Pobierz u≈ºytkownika i starƒÖ ofertƒô
            const userRef = doc(db, "garlic-leaderboard", currentUser.uid);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) return alert("Brak danych u≈ºytkownika.");
          
            const userData = userSnap.data();
          
            const offerRef = doc(db, "offers", id);
            const offerSnap = await getDoc(offerRef);
            if (!offerSnap.exists()) return alert("Oferta ju≈º nie istnieje.");
          
            const oldOffer = offerSnap.data();
          
            // Oblicz r√≥≈ºnicƒô w zasobach
            // Najpierw zwr√≥ƒá stare zasoby
            if (oldOffer.type === "sell") {
              userData.garlic += oldOffer.amount;
            } else {
              userData.money += oldOffer.amount * oldOffer.price;
            }
          
            // Teraz zabierz nowe zasoby
            if (newType === "sell") {
              if (userData.garlic < newAmount) return alert("Nie masz tyle czosnku.");
              userData.garlic -= newAmount;
            } else {
              const cost = newAmount * newPrice;
              if (userData.money < cost) return alert("Nie masz tyle pieniƒôdzy.");
              userData.money -= cost;
            }
          
            // Zaktualizuj zasoby i ofertƒô
            await setDoc(userRef, { garlic: userData.garlic, money: userData.money }, { merge: true });
          
            await setDoc(offerRef, {
              type: newType,
              name: newName,
              amount: newAmount,
              price: newPrice,
              updatedAt: new Date()
            }, { merge: true });
          
            garlicCount.textContent = userData.garlic;
            moneyCount.textContent = userData.money;
          
            offerModal.classList.add("hidden");
            loadOffers();
          };

    
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Usu≈Ñ";
        deleteBtn.onclick = async () => {
          if (!confirm("Czy na pewno chcesz usunƒÖƒá tƒô ofertƒô?")) return;
        
          // Pobierz dane u≈ºytkownika i oferty
          const offerRef = doc(db, "offers", id);
          const offerSnap = await getDoc(offerRef);
          if (!offerSnap.exists()) return alert("Oferta ju≈º nie istnieje.");
        
          const offerData = offerSnap.data();
          const userRef = doc(db, "garlic-leaderboard", offerData.userId);
          const userSnap = await getDoc(userRef);
          if (!userSnap.exists()) return alert("Brak danych u≈ºytkownika.");
        
          const userData = userSnap.data();
        
          // Przywr√≥ƒá zasoby
          if (offerData.type === "sell") {
            // Zwrot czosnku
            await setDoc(userRef, { garlic: userData.garlic + offerData.amount }, { merge: true });
          } else {
            // Zwrot pieniƒôdzy
            const refund = offerData.amount * offerData.price;
            await setDoc(userRef, { money: userData.money + refund }, { merge: true });
          }
        
          // Usu≈Ñ ofertƒô
          await deleteDoc(offerRef);
        
          // Od≈õwie≈º zasoby i oferty
          garlicCount.textContent = userData.garlic + (offerData.type === "sell" ? offerData.amount : 0);
          moneyCount.textContent = userData.money + (offerData.type === "buy" ? offerData.amount * offerData.price : 0);
        
          loadOffers();
        };
        actions.appendChild(deleteBtn);
        actions.appendChild(editBtn);
        
      }
    
      div.appendChild(actions);
      return div;
    }
    



    // Otwiera modal handlu (na razie tylko pokazuje)
    function openTradeModal(id, data) {
      tradeModal.classList.remove("hidden");
      // Mo≈ºesz tu rozbudowaƒá modal o formularz realizacji transakcji
      // Na razie tylko info i przycisk zamkniƒôcia
    }

    tradeModalClose.addEventListener("click", () => {
      tradeModal.classList.add("hidden");
    });

    // Na start ustaw aktywnƒÖ zak≈Çadkƒô i subtab (toplist i kupiƒô)
    document.querySelector('.tab.active').click();
    document.querySelector('.subtab.active').click();
    

  </script>
</body>
</html>
