<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Garlic Trader</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #111;
      color: #f5f5f5;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    .tabs, .subtabs {
      display: flex;
      overflow-x: auto;
      margin-bottom: 10px;
    }
    .tab, .subtab {
      background: #333;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }
    .tab.active, .subtab.active {
      background: #ffd700;
      color: #000;
    }
    .content {
      background: #222;
      padding: 20px;
      border-radius: 0 0 12px 12px;
    }
    .hidden {
      display: none !important;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .status {
      font-size: 16px;
    }
    .button {
      background: #ffd700;
      color: #000;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 5px;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: #222;
      padding: 20px;
      border-radius: 12px;
      width: 300px;
      box-sizing: border-box;
      color: #f5f5f5;
      position: relative;
    }
    .modal h2 {
      margin-top: 0;
    }
    .modal label {
      display: block;
      margin: 10px 0 5px;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: none;
      box-sizing: border-box;
    }
    .modal button {
      margin-top: 15px;
      width: 100%;
      padding: 10px;
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-weight: bold;
      color: #ffd700;
      font-size: 20px;
    }
    /* Offers list */
    .offer {
      background: #333;
      padding: 15px 20px;
      margin-bottom: 12px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      color: #eee;
    }
    
    .offer-details {
      flex-grow: 1;
      padding-right: 20px;
    }
    
    .offer-name {
      font-weight: 700;
      font-size: 28px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    
    .offer-user, .offer-price, .offer-amount {
      font-size: 14px;
      margin-bottom: 4px;
      color: #ccc;
    }
    
    .offer button {
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 8px;
      margin-left: 10px;
      cursor: pointer;
      padding: 10px 18px;
      font-weight: 600;
      transition: background-color 0.3s ease;
      align-self: flex-start;
      height: fit-content;
    }
    
    .offer button:hover {
      background-color: #e6c200;
    }


  </style>
</head>
<body>
  <div class="top-bar">
    <div class="status">
      üßÑ Czosnek: <span id="garlic-count">-</span> | üíµ $: <span id="money-count">-</span>
    </div>
    <div>
      <button class="button" id="login-btn">Zaloguj siƒô</button>
      <button class="button hidden" id="logout-btn">Wyloguj siƒô</button>
    </div>
  </div>
  <h1>Garlic TraderüßÑ</h1>

  <div class="tabs" id="mainTabs">
    <div class="tab" data-tab="market">Market</div>
    <div class="tab" data-tab="farm">Farma</div>
    <div class="tab active" data-tab="toplist">Top listy</div>
  </div>

  <div class="content">
    <div id="market" class="tab-content hidden">
      <div class="subtabs">
        <div class="subtab active" data-subtab="buy">Kupiƒô</div>
        <div class="subtab" data-subtab="sell">Sprzedam</div>
      </div>

      <!-- Przycisk dodawania oferty -->
      <button class="button" id="add-offer-btn">Dodaj ofertƒô</button>

      <div id="buy" class="subtab-content">
        <p>üõí Kup czosnek na rynku!</p>
        <div id="offers-buy">≈Åadowanie ofert kupna...</div>
      </div>

      <div id="sell" class="subtab-content hidden">
        <p>üí∞ Sprzedaj sw√≥j czosnek innym graczom!</p>
        <div id="offers-sell">≈Åadowanie ofert sprzeda≈ºy...</div>
      </div>
    </div>

    <div id="farm" class="tab-content">
      <p>Farma czosnku ‚Äì generuje czosnek w czasie rzeczywistym.</p>
      <div id="farm-stats"></div>
      <div style="margin-top:10px;">
        <button class="button" id="collect-button">Zbierz czosnek</button>
        <button class="button" id="upgrade-farm">Powiƒôksz Farmƒô</button>
        <button class="button" id="upgrade-fertilizer">Naw√≥≈∫ Farmƒô</button>
        <button class="button" id="upgrade-automation">Automatyzuj Farmƒô</button>
        <button class="button" id="upgrade-storage">Powiƒôksz Magazyn</button>
      </div>
    </div>


    <div id="toplist" class="tab-content">
      <p>ü•á Top gracze wg ilo≈õci czosnku:</p>
      <div id="top-garlic">≈Åadowanie...</div>
      <p>üíµ Top gracze wg ilo≈õci pieniƒôdzy:</p>
      <div id="top-money">≈Åadowanie...</div>
    </div>
  </div>

  <!-- Modal dodawania oferty -->
  <div id="offer-modal" class="modal-overlay hidden">
    <div class="modal">
      <span class="modal-close" id="offer-modal-close">&times;</span>
      <h2>Dodaj ofertƒô</h2>
      <form id="offer-form">
        <label for="offer-type">Typ oferty:</label>
        <select id="offer-type" required>
          <option value="buy">Kupiƒô</option>
          <option value="sell">Sprzedam</option>
        </select>
        <label for="offer-name">Nazwa oferty:</label>
        <input type="text" id="offer-name" required placeholder="Nazwa oferty" />
        <label for="offer-amount">Ilo≈õƒá:</label>
        <input type="number" id="offer-amount" min="1" required placeholder="Ilo≈õƒá" />
        <label for="offer-price">Cena za sztukƒô ($):</label>
        <input type="number" id="offer-price" min="1" step="1" required placeholder="Cena" />
        <button type="submit">Dodaj ofertƒô</button>
      </form>
    </div>
  </div>
  
  <!-- Modal handlu -->
  <div id="trade-modal" class="modal-overlay hidden">
    <div class="modal">
      <span class="modal-close" id="trade-modal-close">&times;</span>
      <h2 id="trade-title">Handel</h2>
      <p id="trade-info"></p>
      <form id="trade-form">
        <label for="trade-quantity">Ilo≈õƒá:</label>
        <input type="number" id="trade-quantity" min="1" required />
        <label id="cal-price">Cena:</label>
        <button type="submit">Wykonaj handel</button>
      </form>
    </div>
  </div>



  <script type="module">
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, orderBy, limit, addDoc, where } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const encodedConfig = {
      apiKey: "QUl6YVN5Q280RTg4ZUpydW1TcGgxZ3lpelB4TUcybm4yWXlNVng4",
      authDomain: "Z2llbGRhLTIwMTcyLmZpcmViYXNlYXBwLmNvbQ==",
      projectId: "Z2llbGRhLTIwMTcy",
      storageBucket: "Z2llbGRhLTIwMTcyLmFwcHNwb3QuY29t",
      messagingSenderId: "OTg1NDU1NzcwODA1",
      appId: "MTo5ODU0NTU3NzA4MDU6d2ViOmE4MGFhZjUzNmE2YTVkMDY0YzUyZmM="
    };
    const firebaseConfig = {};
    for (const key in encodedConfig) {
      firebaseConfig[key] = atob(encodedConfig[key]);
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const garlicCount = document.getElementById("garlic-count");
    const moneyCount = document.getElementById("money-count");

    const addOfferBtn = document.getElementById("add-offer-btn");
    const offerModal = document.getElementById("offer-modal");
    const offerModalClose = document.getElementById("offer-modal-close");
    const offerForm = document.getElementById("offer-form");

    const tradeModal = document.getElementById("trade-modal");
    const tradeModalClose = document.getElementById("trade-modal-close");
    const tradeForm = document.getElementById("trade-form");
    const priceLabel = document.getElementById("cal-price");
    const tradeQ = document.getElementById("trade-quantity");

    const offersBuyDiv = document.getElementById("offers-buy");
    const offersSellDiv = document.getElementById("offers-sell");

    let currentUser = null;

    loginBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, async user => {
      const marketTab = document.querySelector('[data-tab="market"]');
      const farmTab = document.querySelector('[data-tab="farm"]');
      if (user) {
        currentUser = user;
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        marketTab.classList.remove("hidden");
        farmTab.classList.remove("hidden");
        addOfferBtn.style.display = "inline-block";
        await loadOrCreatePlayer(user);
        await loadOffers();
      } else {
        currentUser = null;
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        garlicCount.textContent = "-";
        moneyCount.textContent = "-";
        marketTab.classList.add("hidden");
        farmTab.classList.add("hidden");
        addOfferBtn.style.display = "none";
        offersBuyDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        offersSellDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        document.querySelector('[data-tab="toplist"]').click();
      }
    });
    async function reloadStats(){
      const ref = doc(db, "garlic-leaderboard", currentUser.uid);
      const snap = await getDoc(ref);
      const data = snap.data();
      garlicCount.textContent = data.garlic;
      moneyCount.textContent = data.money;
    }
    async function loadOrCreatePlayer(user) {
      const ref = doc(db, "garlic-leaderboard", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          name: user.displayName,
          garlic: 5,
          money: 100,
          farmLevel: 0,
          fertilizerLevel: 0,
          automationLevel: 0,
          storageLevel: 0,
          garlicInFarm: 0,
          lastGenerated: Date.now()
        });
        garlicCount.textContent = 5;
        moneyCount.textContent = 100;
      } else {
        const data = snap.data();
        garlicCount.textContent = data.garlic;
        moneyCount.textContent = data.money;
      }
    }
    async function getFireData(storeId, user) {
      const ref = doc(db, storeId, user);
      const snap = await getDoc(ref);
      const data = snap.data();
      return data;
    } 
		function tokenToNumber(token) {
		    // Zamie≈Ñ token na warto≈õƒá z zakresu 0..1
		    let hash = 0;
		    for (let i = 0; i < token.length; i++) {
		        hash = (hash * 31 + token.charCodeAt(i)) % 1000000007;
		    }
		
		    // Normalizacja do zakresu 0..1
		    const normalized = hash / 1000000007;
		
		    // Skalowanie symetryczne
		    let result;
		    if (normalized < 0.5) {
		        // 0..0.5 => 0.18..1
		        const t = normalized / 0.5;
		        result = 0.18 + t * (1 - 0.18);
		    } else {
		        // 0.5..1 => 1..4
		        const t = (normalized - 0.5) / 0.5;
		        result = 1 + t * (4 - 1);
		    }
		
		    return parseFloat(result.toFixed(3));
		}


    
    async function changeStats(user, garlicAm, moneyAm) {
      
      const ref = doc(db, "garlic-leaderboard", user);
      const snap = await getDoc(ref);
      const data = snap.data();
      let newGar = parseInt(garlicAm,10)+parseInt(data.garlic,10);
      let newMon = parseInt(moneyAm,10)+parseInt(data.money,10);
      
      const maxGarlic = 100 + 50 * (data.storageLevel || 0);
      newGar = Math.min(newGar, maxGarlic);
      
      await setDoc(ref, {...data, name: data.name, garlic: newGar, money: newMon });
      garlicCount.textContent = newGar;
      moneyCount.textContent = newMon;
    }
    async function renderFarmUI() {
      const ref = doc(db, "garlic-leaderboard", currentUser.uid);
      const snap = await getDoc(ref);
      const data = snap.data();
      const farm = getFarmState(data);
      const automation = data.automationLevel || 0;
    
      const farmLevel = data.farmLevel || 0;
      const fertilizerLevel = data.fertilizerLevel || 0;
      const storageLevel = data.storageLevel || 0;
      const autoLevel = data.automationLevel || 0;
    
      const farmCost = Math.floor(tokenToNumber(currentUser.uid) * getCost(farmLevel, 20, 1.8));
      const fertCost = getCost(fertilizerLevel, 50, 2);
      const autoCost = getCost(autoLevel, 100, 2.5);
      const storeCost = getCost(storageLevel, 50, 2);
    
      const maxGarlic = 100 + 50 * storageLevel;
      document.getElementById("upgrade-farm").innerText = `Powiƒôksz farmƒô (${farmCost} üßÑ)`;
      document.getElementById("upgrade-fertilizer").innerText = `Naw√≥≈∫ farmƒô (${fertCost} üíµ)`;
      document.getElementById("upgrade-automation").innerText = `Automatyzuj (${autoCost} üíµ)`;
      document.getElementById("upgrade-storage").innerText = `Powiƒôksz magazyn (${storeCost} üíµ)`;

      const farmDiv = document.getElementById("farm-stats");
      farmDiv.innerHTML = `
        üå± Poziom farmy: ${farmLevel} ‚Äì koszt: üßÑ ${farmCost}<br/>
        üß™ Naw√≥z: ${fertilizerLevel} ‚Äì koszt: üíµ ${fertCost}<br/>
        ü§ñ Automatyzacja: ${autoLevel} ‚Äì koszt: üíµ ${autoCost}<br/>
        üßë‚Äçüåæ Nast. zebranie za: ${Math.floor(farm.nextCollect / 1000)}s<br/>
        üß∫ Magazyn: ${storageLevel} (max: ${maxGarlic}) ‚Äì koszt: üíµ ${storeCost}<br/>
        ‚è≥ Nast. cykl za: ${Math.floor(farm.nextCycle / 1000)}s<br/>
        üßÑ W farmie: ${Math.floor(farm.garlicInFarm)}
      `;
      
      // zapis stanu farmy (opcjonalny)
      
    }
    
    setInterval(renderFarmUI, 1000);

    async function collectGarlic(auto = false) {
      const ref = doc(db, "garlic-leaderboard", currentUser.uid);
      const snap = await getDoc(ref);
      const data = snap.data();
      const farm = getFarmState(data);
      const collected = Math.floor(farm.garlicInFarm);
    
      if (collected <= 0) {
        if (!auto) console.error("brak");
        return;
      }
    
      await setDoc(ref, {
        ...data,
        garlic: data.garlic + collected,
        garlicInFarm: 0,
        lastGenerated: farm.now
      });
      await changeStats(currentUser.uid, 0,0);
      garlicCount.textContent = data.garlic + collected;
      await reloadStats();
      renderFarmUI();
    }
    document.getElementById("collect-button").addEventListener("click", () => {
      collectGarlic(false);
      renderFarmUI();
    });

    async function loadTopLists() {
      const garlicDiv = document.getElementById("top-garlic");
      const moneyDiv = document.getElementById("top-money");

      try {
        const ref = collection(db, "garlic-leaderboard");

        const garlicQ = query(ref, orderBy("garlic", "desc"), limit(10));
        const moneyQ = query(ref, orderBy("money", "desc"), limit(10));

        const garlicSnap = await getDocs(garlicQ);
        const moneySnap = await getDocs(moneyQ);

        garlicDiv.innerHTML = "<ol>" + garlicSnap.docs.map(doc => `<li>${doc.data().name}: ${doc.data().garlic}</li>`).join("") + "</ol>";
        moneyDiv.innerHTML = "<ol>" + moneySnap.docs.map(doc => `<li>${doc.data().name}: $${doc.data().money}</li>`).join("") + "</ol>";
      } catch (e) {
        garlicDiv.textContent = moneyDiv.textContent = "B≈ÇƒÖd ≈Çadowania top list.";
        console.error(e);
      }
    }

    // ≈Åaduj top listy od razu
    loadTopLists();

    // Tab switching logic
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if ((tab.dataset.tab === 'market' || tab.dataset.tab === 'farm') && !currentUser) return;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.remove('hidden');
      });
    });

    document.querySelectorAll('.subtab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.subtab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.subtab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.subtab).classList.remove('hidden');
      });
    });

    // Obs≈Çuga modala dodawania oferty
    addOfferBtn.addEventListener('click', () => {
      if (!currentUser) return alert("Zaloguj siƒô, aby dodaƒá ofertƒô.");
      offerForm.reset();
      // Ustaw typ oferty w modalu wg aktualnej subtaba (buy/sell)
      const activeSubtab = document.querySelector('.subtab.active').dataset.subtab;
      document.getElementById("offer-type").value = activeSubtab;
      offerModal.classList.remove('hidden');
    });

    offerModalClose.addEventListener('click', () => {
      offerModal.classList.add('hidden');
    });

    offerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Zaloguj siƒô, aby dodaƒá ofertƒô.");

      const type = document.getElementById("offer-type").value;
      const name = document.getElementById("offer-name").value.trim();
      const amount = parseInt(document.getElementById("offer-amount").value, 10);
      const price = parseFloat(document.getElementById("offer-price").value);

      if (!name || amount <= 0 || price <= 0) {
        return alert("Proszƒô podaƒá poprawne dane.");
      }
      let dejt = await getFireData("garlic-leaderboard", currentUser.uid);
      let garAm = dejt.garlic;
      let monAm = dejt.money;
      if (type==="sell") {
        if (garAm<amount) return alert("Za ma≈Ço czosnku");
        await changeStats(currentUser.uid, -1 * amount, 0);
      }
      if (type==="buy") {
        if (monAm<(amount * price)) return alert("Za ma≈Ço pieniƒôdzy");
        await changeStats(currentUser.uid, 0, -1 * amount * price);
      }

      try {
        await addDoc(collection(db, "offers"), {
          userId: currentUser.uid,
          userName: currentUser.displayName,
          type, // "buy" lub "sell"
          name,
          amount,
          price,
          createdAt: new Date()
        });
        
        offerModal.classList.add('hidden');
        loadOffers(); // od≈õwie≈º listƒô ofert
      } catch (error) {
        console.error(error);
        alert("B≈ÇƒÖd podczas dodawania oferty.");
      }
    });

    // ≈Åadowanie ofert z Firestore i wy≈õwietlanie ich
    async function loadOffers() {
      if (!currentUser) {
        offersBuyDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        offersSellDiv.innerHTML = "Zaloguj siƒô, aby zobaczyƒá oferty.";
        return;
      }

      offersBuyDiv.textContent = "≈Åadowanie...";
      offersSellDiv.textContent = "≈Åadowanie...";

      try {
        const offersRef = collection(db, "offers");

        // Kup
